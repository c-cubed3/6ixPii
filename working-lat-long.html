<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Muli|Philosopher:400,700" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
    <title>Bathroom App</title>
</head>
<body>
        <div class="text-container">
            <h1>I need to pee.</h1>
            <p>Looking for a last minute bathroom?</p>
            <button>Locate a stall near me!</button>
            
            <div id="map"></div>
            <div class="bathroom-results-container">
                <div class="bathroom-location"></div>
                <div class="bathroom-location"></div>
                <div class="bathroom-location"></div>
                <div class="bathroom-location"></div>
                <div class="bathroom-location"></div>
                <div class="bathroom-location"></div>
            </div>
        </div>

    <script src='https://code.jquery.com/jquery-3.2.1.min.js' integrity='sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4='crossorigin='anonymous'></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbq2MoZkppvEWbIonDVq9SU2TWhktZsPE">
    </script>
    <script>

        //create an app namesape to hold all methods
        const pos = {};

        //create an empty array to house filtered location
        //results coordinates 
        const locations = [];
        const locationsList = () => {
            for (let i = 0; i < locations.length; i++) {
                    console.log(locations[i].lat);
                }
            }


        // array with types to be passed in arguments
        pos.venues = ['cafe', 'gas_station', `shopping_mall`];

        // get user permission to track location
        // through button above map
        pos.getLocation = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    pos.lat = position.coords.latitude;
                    pos.lng = position.coords.longitude;
                    pos.latlng = position.coords.latitude + ',' + position.coords.longitude;
                    // pass in pos.getVenues to access user location
                    pos.getVenues();
                    //calling the changeMap callback function:
                    pos.changeMap(pos.lat, pos.lng, pos.lat, pos.lng);
                    //
                });
            }
        }
        
        //  essentially a function to have all the params in the pos.venues
        // array passed one by one to the ajax requesst and use $.when() .
        //to retrieve into and pass it all into one array
        pos.getVenues= () => {

            finalLocations = pos.venues.map((item) => {
                return pos.getVenue(item);
            });

            $.when(...finalLocations)
            .then((...locations) => {
                locations = locations 
                .map(el => el[0].results)
                .reduce((acc,curr) => [...acc,...curr],[])
                .map(el2 => el2.geometry.location);
                console.log(locations);
                let locationCoordinates = locations[0];
                let locationCoordinates2 = locations[1];
                let locationCoordinates3 = locations[2];
                let locationCoordinates4 = locations[3];
                let locationCoordinates5 = locations[4];
                let locationCoordinates6 = locations[5];
                pos.addMarkers(locationCoordinates, locationCoordinates2, locationCoordinates3, locationCoordinates4, locationCoordinates5, locationCoordinates6);
            });
        }

        
        // ajax req
        pos.getVenue = function (venueType) {
            return $.ajax({
                url: 'https://proxy.hackeryou.com',
                method: 'GET',
                dataType: 'json',
                data: {
                    reqUrl: 'https://maps.googleapis.com/maps/api/place/nearbysearch/json',
                    params: {
                        key: 'AIzaSyANaLsqMb-Vp4_WS06TGn6F2Whc_XB8Lbc',
                        location: `${pos.lat},${pos.lng}`,
                        rankby: `distance`,
                        type: venueType
                    },
                },
            })
        }


    //change the map to reflect the users location
    pos.changeMap = function initMap(lat, lng, userLat, userLng) {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: lat, lng: lng },
            zoom: 15
        });
        infoWindow = new google.maps.InfoWindow;
        let UserLocation = new google.maps.Marker({
            position: { lat: userLat, lng: userLng },
            map: map,
            title: 'You are here!',
            animation: google.maps.Animation.BOUNCE
        });
    }



    //add six markers to showcase the closet six results from our API search
    pos.addMarkers = function initMap(locationCoordinates, locationCoordinates2, locationCoordinates3, locationCoordinates4, locationCoordinates5, locationCoordinates6) {
        const icon = {

            path: "M49.597,98.368L27.234,35.261c-1.82-5.123-1.82-10.72,0-15.85C31.611,7.06,45.171,0.597,57.521,4.976  C69.873,9.35,76.338,22.909,71.961,35.261L49.597,98.368z M50.199,44.18V10.496h-1.205V44.18H50.199z M57.91,40.112  c0.637,0,1.154-0.514,1.154-1.156v-6.709h1.061v6.709c0,0.643,0.518,1.156,1.156,1.156s1.158-0.514,1.158-1.156v-6.709h1.361  l-1.361-6.23v-1.341c0-0.067,0.039-0.122,0.102-0.148c0.08-0.033,0.174,0.006,0.209,0.087c0.643,1.571,0.979,3.252,0.98,4.952  c0,0.544,0.445,0.984,0.988,0.984s0.986-0.443,0.986-0.988c-0.01-3.106-0.971-6.132-2.76-8.67c-0.182-0.264-0.484-0.42-0.805-0.42  h-5.09c-0.32,0-0.621,0.156-0.805,0.42c-1.789,2.538-2.754,5.563-2.76,8.67c-0.002,0.545,0.443,0.988,0.986,0.988  c0.545,0,0.988-0.44,0.988-0.984c0.002-1.7,0.336-3.381,0.977-4.952c0.027-0.061,0.086-0.102,0.152-0.102  c0.09,0,0.164,0.075,0.164,0.163v1.29l-1.363,6.281h1.363v6.709C56.754,39.599,57.273,40.112,57.91,40.112z M41.287,40.112  c0.639,0,1.156-0.514,1.156-1.156v-8.704v-5.576c0-0.067,0.037-0.122,0.098-0.148c0.086-0.033,0.182,0.006,0.213,0.087  c0.645,1.571,0.975,3.252,0.979,4.952c0,0.544,0.443,0.984,0.988,0.984s0.988-0.443,0.984-0.988  c-0.002-3.106-0.965-6.132-2.754-8.67c-0.186-0.264-0.486-0.42-0.809-0.42h-5.09c-0.318,0-0.619,0.156-0.805,0.42  c-1.787,2.538-2.752,5.563-2.758,8.67c0,0.545,0.438,0.988,0.984,0.988c0.549,0,0.988-0.44,0.992-0.984  c0.004-1.7,0.334-3.381,0.977-4.952c0.025-0.061,0.084-0.102,0.148-0.102c0.094,0,0.164,0.075,0.164,0.163v5.576v8.704  c0,0.643,0.516,1.156,1.156,1.156s1.158-0.514,1.158-1.156v-8.704c0-0.291,0.236-0.527,0.527-0.527c0.295,0,0.531,0.236,0.531,0.527  v8.704C40.128,39.599,40.646,40.112,41.287,40.112z M61.986,16.899c0-1.292-1.045-2.341-2.336-2.341  c-1.293,0-2.338,1.049-2.338,2.341c0,1.286,1.045,2.335,2.338,2.335C60.941,19.234,61.986,18.186,61.986,16.899L61.986,16.899z   M41.992,16.899c0-1.292-1.047-2.341-2.34-2.341c-1.289,0-2.334,1.049-2.334,2.341c0,1.286,1.045,2.335,2.334,2.335  C40.945,19.234,41.992,18.186,41.992,16.899L41.992,16.899z",
            fillColor: '#000000',
            fillOpacity: .8,
            strokeWeight: 0,
            scale: 0.3
        }
        //FIRST LOCATION MARKER
        let marker1 = new google.maps.Marker({
            position: locationCoordinates,
            map: map,
            icon: icon
        });

        let marker1Content= `first location!`;

        let infowindow1 = new google.maps.InfoWindow({
            content: marker1Content,
            maxWidth: 100
        });

        marker1.addListener('click', function () {
            infowindow1.open(map, marker1);
        });
        
        //SECOND LOCATION MARKER
        let marker2 = new google.maps.Marker({
            position: locationCoordinates2,
            map: map,
            icon: icon
        });

        
        let marker2Content = `Second location!`;

        let infowindow2 = new google.maps.InfoWindow({
            content: marker2Content,
            maxWidth: 100
        });

        marker2.addListener('click', function () {
            infowindow2.open(map, marker2);
        });

        //THIRD LOCATION MARKER
        let marker3 = new google.maps.Marker({
            position: locationCoordinates3,
            map: map,
            icon: icon
        });

         let marker3Content = `Third location!`;

        let infowindow3 = new google.maps.InfoWindow({
            content: marker3Content,
            maxWidth: 100
        });

        marker3.addListener('click', function () {
            infowindow3.open(map, marker3);
        });

        //FOURTH LOCATION MARKER
        let marker4 = new google.maps.Marker({
            position: locationCoordinates4,
            map: map,
            icon: icon
        });

         let marker4Content = `Fourth location!`;

        let infowindow4 = new google.maps.InfoWindow({
            content: marker4Content,
            maxWidth: 100
        });

        marker4.addListener('click', function () {
            infowindow4.open(map, marker4);
        });

        //FIFTH LOCATION MARKER
        let marker5 = new google.maps.Marker({
            position: locationCoordinates5,
            map: map,
            icon: icon
        });

         let marker5Content = `Fifth location!`;

        let infowindow5 = new google.maps.InfoWindow({
            content: marker5Content,
            maxWidth: 100
        });

        marker5.addListener('click', function () {
            infowindow5.open(map, marker5);
        });

        //SIXTH LOCATION MARKER
        let marker6 = new google.maps.Marker({
            position: locationCoordinates6,
            map: map,
            icon: icon
        });

         let marker6Content = `Sixth location!`;

        let infowindow6 = new google.maps.InfoWindow({
            content: marker6Content,
            maxWidth: 100
        });

        marker6.addListener('click', function () {
            infowindow6.open(map, marker6);
        });
    }

        //This is the original map function that displays the Google Map of Toronto
        //When the page originally loads.
        //I currently don't have a marker set up
        pos.makeMap = function initMap() {
            let toronto = { lat: 43.6532, lng: -79.3832 };
            let map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: toronto
            });
        }

        // just a button for user to click to give permission 
        $(function () {
            $('button').on('click', function () {
                pos.getLocation();
            });
            pos.makeMap();
        });
    </script>    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANaLsqMb-Vp4_WS06TGn6F2Whc_XB8Lbc&callback=getLocation">
    </script>
</body>
</html>